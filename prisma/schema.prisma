generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  CCRO_TEAM
  OWNER
  VIEWER
}

enum ReportStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum RAGStatus {
  GOOD
  WARNING
  HARM
}

enum SectionType {
  TEXT_BLOCK
  DATA_TABLE
  CONSUMER_DUTY_DASHBOARD
  CHART
  CARD_GRID
  IMPORTED_COMPONENT
  TEMPLATE_INSTANCE
  ACCORDION
  IMAGE_BLOCK
}

enum ActionStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  OVERDUE
  PROPOSED_CLOSED
}

enum ActionPriority {
  P1
  P2
  P3
}

enum ChangeStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ControlEffectiveness {
  EFFECTIVE
  PARTIALLY_EFFECTIVE
  INEFFECTIVE
}

enum RiskAppetite {
  VERY_LOW
  LOW
  LOW_TO_MODERATE
  MODERATE
}

enum DirectionOfTravel {
  IMPROVING
  STABLE
  DETERIORATING
}

enum MitigationStatus {
  OPEN
  IN_PROGRESS
  COMPLETE
}

model User {
  id                  String    @id @default(cuid())
  email               String    @unique
  name                String
  role                Role      @default(VIEWER)
  assignedMeasures    String[]
  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  lastLoginAt         DateTime?
  updatedAt           DateTime  @updatedAt

  reports         Report[]        @relation("CreatedReports")
  versions        ReportVersion[] @relation("PublishedVersions")
  templates       Template[]
  components      Component[]
  auditLogs       AuditLog[]
  assignedActions Action[]        @relation("AssignedActions")
  createdActions  Action[]        @relation("CreatedActions")
  proposedChanges ActionChange[]  @relation("ProposedChanges")
  reviewedChanges ActionChange[]  @relation("ReviewedChanges")
  createdRisks    Risk[]          @relation("CreatedRisks")
  updatedRisks    Risk[]          @relation("UpdatedRisks")
  ownedRisks      Risk[]          @relation("OwnedRisks")

  updatedMeasures ConsumerDutyMeasure[]  @relation("MeasureUpdater")

  // Risk Acceptance Module
  proposedAcceptances    RiskAcceptance[]        @relation("AcceptanceProposer")
  approverAcceptances    RiskAcceptance[]        @relation("AcceptanceApprover")
  acceptanceComments     RiskAcceptanceComment[]
  acceptanceHistory      RiskAcceptanceHistory[]

  // Policy Review Module
  ownedPolicies       Policy[]               @relation("OwnedPolicies")

  // Controls Testing Module
  ownedControls       Control[]              @relation("ControlOwner")
  createdControls     Control[]              @relation("ControlCreatedBy")
  attestations        ControlAttestation[]   @relation("AttestationBy")
  assignedTests       TestingScheduleEntry[] @relation("AssignedTester")
  addedSchedules      TestingScheduleEntry[] @relation("ScheduleAddedBy")
  testResults         ControlTestResult[]    @relation("TestResultBy")
  updatedTestResults  ControlTestResult[]    @relation("TestResultUpdatedBy")
  authoredSummaries   QuarterlySummary[]     @relation("SummaryAuthor")
  approvedSummaries   QuarterlySummary[]     @relation("SummaryApprover")
  configuredExcoViews ExcoViewConfig[]       @relation("ExcoConfiguredBy")
  ccroReviews         ControlAttestation[]   @relation("AttestationCCROReviewer")
  controlProposedChanges  ControlChange[]  @relation("ControlProposedChanges")
  controlReviewedChanges  ControlChange[]  @relation("ControlReviewedChanges")

  // Risk Changes Module
  riskProposedChanges  RiskChange[]  @relation("RiskProposedChanges")
  riskReviewedChanges  RiskChange[]  @relation("RiskReviewedChanges")

  // Dashboard Notifications
  createdNotifications DashboardNotification[] @relation("NotificationCreator")

  @@map("users")
}

model Report {
  id        String       @id @default(cuid())
  title     String
  period    String
  status    ReportStatus @default(DRAFT)
  createdBy String
  creator   User         @relation("CreatedReports", fields: [createdBy], references: [id])
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  sections  Section[]
  versions  ReportVersion[]
  outcomes  ConsumerDutyOutcome[]
  auditLogs AuditLog[]
  actions   Action[]

  @@map("reports")
}

model Section {
  id           String      @id @default(cuid())
  reportId     String
  report       Report      @relation(fields: [reportId], references: [id], onDelete: Cascade)
  type         SectionType
  position     Int
  title        String?
  content      Json        @default("{}")
  layoutConfig Json        @default("{}")
  styleConfig  Json        @default("{}")
  templateId   String?
  componentId  String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@map("sections")
}

model ConsumerDutyOutcome {
  id                   String    @id @default(cuid())
  reportId             String?
  report               Report?   @relation(fields: [reportId], references: [id], onDelete: Cascade)
  outcomeId            String
  name                 String
  shortDesc            String
  detailedDescription  String?   @db.Text
  riskOwner            String?
  previousRAG          RAGStatus?
  mitigatingActions    String?   @db.Text
  monthlySummary       String?   @db.Text
  icon                 String?
  ragStatus            RAGStatus @default(GOOD)
  position             Int       @default(0)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  measures ConsumerDutyMeasure[]
  riskAcceptances RiskAcceptance[]

  @@unique([reportId, outcomeId])
  @@index([reportId])
  @@map("consumer_duty_outcomes")
}

model ConsumerDutyMeasure {
  id            String    @id @default(cuid())
  outcomeId     String
  outcome       ConsumerDutyOutcome @relation(fields: [outcomeId], references: [id], onDelete: Cascade)
  measureId     String
  name          String
  owner         String?
  summary       String    @default("")
  ragStatus     RAGStatus @default(GOOD)
  position      Int       @default(0)
  lastUpdatedAt DateTime?
  updatedById   String?
  updatedByUser User?     @relation("MeasureUpdater", fields: [updatedById], references: [id])
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  metrics ConsumerDutyMI[]

  @@map("consumer_duty_measures")
}

model ConsumerDutyMI {
  id               String    @id @default(cuid())
  measureId        String
  measure          ConsumerDutyMeasure @relation(fields: [measureId], references: [id], onDelete: Cascade)
  metric           String
  current          String    @default("")
  previous         String    @default("")
  change           String    @default("")
  ragStatus        RAGStatus @default(GOOD)
  appetite         String?
  appetiteOperator String?
  narrative        String?   @db.Text
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  snapshots MetricSnapshot[]
  actions   Action[]         @relation("ConsumerDutyMIActions")

  @@map("consumer_duty_mi")
}

model MetricSnapshot {
  id        String    @id @default(cuid())
  miId      String
  mi        ConsumerDutyMI @relation(fields: [miId], references: [id], onDelete: Cascade)
  month     DateTime
  value     String
  ragStatus RAGStatus @default(GOOD)
  createdAt DateTime  @default(now())

  @@unique([miId, month])
  @@index([miId])
  @@map("metric_snapshots")
}

model ReportVersion {
  id           String   @id @default(cuid())
  reportId     String
  report       Report   @relation(fields: [reportId], references: [id], onDelete: Cascade)
  version      Int
  snapshotData Json
  htmlExport   String?  @db.Text
  publishedBy  String
  publisher    User     @relation("PublishedVersions", fields: [publishedBy], references: [id])
  publishedAt  DateTime @default(now())
  publishNote  String?

  @@unique([reportId, version])
  @@map("report_versions")
}

model Template {
  id            String      @id @default(cuid())
  name          String
  description   String      @default("")
  category      String      @default("General")
  thumbnailUrl  String?
  layoutConfig  Json        @default("{}")
  styleConfig   Json        @default("{}")
  contentSchema Json        @default("[]")
  sectionType   SectionType @default(TEXT_BLOCK)
  createdBy     String
  creator       User        @relation(fields: [createdBy], references: [id])
  isGlobal      Boolean     @default(false)
  version       Int         @default(1)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@map("templates")
}

model Component {
  id          String   @id @default(cuid())
  name        String
  description String   @default("")
  category    String   @default("General")
  htmlContent String   @db.Text
  cssContent  String?  @db.Text
  jsContent   String?  @db.Text
  version     String   @default("1.0")
  sanitized   Boolean  @default(false)
  createdBy   String
  creator     User     @relation(fields: [createdBy], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("components")
}

model AuditLog {
  id         String   @id @default(cuid())
  timestamp  DateTime @default(now())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  userRole   Role
  action     String
  entityType String
  entityId   String?
  changes    Json?
  reportId   String?
  report     Report?  @relation(fields: [reportId], references: [id], onDelete: SetNull)
  ipAddress  String?
  userAgent  String?

  @@index([userId])
  @@index([reportId])
  @@index([timestamp])
  @@index([action])
  @@map("audit_logs")
}

model Action {
  id            String       @id @default(cuid())
  reference     String       @unique
  reportId      String?
  report        Report?      @relation(fields: [reportId], references: [id], onDelete: Cascade)
  reportPeriod  String?
  source        String?      @db.Text
  sectionId     String?
  sectionTitle  String?
  title         String
  description      String       @default("") @db.Text
  issueDescription String?      @db.Text
  status           ActionStatus @default(OPEN)
  priority      ActionPriority?
  assignedTo    String
  assignee      User         @relation("AssignedActions", fields: [assignedTo], references: [id])
  createdBy     String
  creator       User         @relation("CreatedActions", fields: [createdBy], references: [id])
  controlId     String?
  control       Control?     @relation("ControlActions", fields: [controlId], references: [id], onDelete: SetNull)
  consumerDutyMIId String?
  consumerDutyMI   ConsumerDutyMI? @relation("ConsumerDutyMIActions", fields: [consumerDutyMIId], references: [id], onDelete: SetNull)
  dueDate       DateTime?
  completedAt   DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  changes          ActionChange[]
  linkedMitigation RiskMitigation? @relation("MitigationAction")

  @@index([reportId])
  @@index([assignedTo])
  @@index([status])
  @@index([dueDate])
  @@index([source])
  @@index([controlId])
  @@index([consumerDutyMIId])
  @@map("actions")
}

model ActionChange {
  id           String       @id @default(cuid())
  actionId     String
  action       Action       @relation(fields: [actionId], references: [id], onDelete: Cascade)
  proposedBy   String
  proposer     User         @relation("ProposedChanges", fields: [proposedBy], references: [id])
  fieldChanged String
  oldValue     String?      @db.Text
  newValue     String?      @db.Text
  proposedAt   DateTime     @default(now())
  status       ChangeStatus @default(PENDING)
  reviewedBy   String?
  reviewer     User?        @relation("ReviewedChanges", fields: [reviewedBy], references: [id])
  reviewedAt   DateTime?
  reviewNote   String?
  evidenceUrl  String?      @db.Text
  evidenceName String?
  isUpdate     Boolean      @default(false)

  @@index([actionId])
  @@index([status])
  @@map("action_changes")
}

model ControlChange {
  id           String       @id @default(cuid())
  controlId    String
  control      Control      @relation(fields: [controlId], references: [id], onDelete: Cascade)
  proposedBy   String
  proposer     User         @relation("ControlProposedChanges", fields: [proposedBy], references: [id])
  fieldChanged String
  oldValue     String?      @db.Text
  newValue     String?      @db.Text
  rationale    String       @db.Text
  proposedAt   DateTime     @default(now())
  status       ChangeStatus @default(PENDING)
  reviewedBy   String?
  reviewer     User?        @relation("ControlReviewedChanges", fields: [reviewedBy], references: [id])
  reviewedAt   DateTime?
  reviewNote   String?

  @@index([controlId])
  @@index([status])
  @@map("control_changes")
}

// ── Risk Register ──────────────────────────────────────────────────────────────

model RiskCategory {
  id         String  @id @default(cuid())
  level      Int
  parentId   String?
  parent     RiskCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children   RiskCategory[] @relation("CategoryHierarchy")
  name       String
  definition String  @db.Text

  @@map("risk_categories")
}

model Risk {
  id                   String               @id @default(cuid())
  reference            String               @unique
  name                 String
  description          String               @db.Text
  categoryL1           String
  categoryL2           String
  ownerId              String
  riskOwner            User                 @relation("OwnedRisks", fields: [ownerId], references: [id])
  inherentLikelihood   Int
  inherentImpact       Int
  residualLikelihood   Int
  residualImpact       Int
  controlEffectiveness ControlEffectiveness?
  riskAppetite         RiskAppetite?
  directionOfTravel    DirectionOfTravel    @default(STABLE)
  reviewFrequencyDays  Int                  @default(90)
  reviewRequested      Boolean              @default(false)
  lastReviewed         DateTime             @default(now()) @db.Date
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  createdBy            String
  creator              User                 @relation("CreatedRisks", fields: [createdBy], references: [id])
  updatedBy            String
  updater              User                 @relation("UpdatedRisks", fields: [updatedBy], references: [id])

  controls    RiskControl[]
  mitigations RiskMitigation[]
  auditTrail  RiskAuditLog[]
  snapshots   RiskSnapshot[]
  acceptances RiskAcceptance[]
  changes     RiskChange[]

  @@index([categoryL1])
  @@index([ownerId])
  @@map("risks")
}

model RiskControl {
  id          String   @id @default(cuid())
  riskId      String
  risk        Risk     @relation(fields: [riskId], references: [id], onDelete: Cascade)
  description String   @db.Text
  controlOwner String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([riskId])
  @@map("risk_controls")
}

model RiskMitigation {
  id           String           @id @default(cuid())
  riskId       String
  risk         Risk             @relation(fields: [riskId], references: [id], onDelete: Cascade)
  action       String           @db.Text
  owner        String?
  deadline     DateTime?        @db.Date
  status       MitigationStatus @default(OPEN)
  priority     ActionPriority?
  actionId     String?          @unique
  linkedAction Action?          @relation("MitigationAction", fields: [actionId], references: [id], onDelete: Cascade)
  createdAt    DateTime         @default(now())

  @@index([riskId])
  @@index([actionId])
  @@map("risk_mitigations")
}

model RiskSnapshot {
  id                  String            @id @default(cuid())
  riskId              String
  risk                Risk              @relation(fields: [riskId], references: [id], onDelete: Cascade)
  month               DateTime
  residualLikelihood  Int
  residualImpact      Int
  inherentLikelihood  Int
  inherentImpact      Int
  directionOfTravel   DirectionOfTravel @default(STABLE)

  @@unique([riskId, month])
  @@index([riskId])
  @@map("risk_snapshots")
}

model RiskAuditLog {
  id           String   @id @default(cuid())
  riskId       String
  risk         Risk     @relation(fields: [riskId], references: [id], onDelete: Cascade)
  userId       String
  action       String
  fieldChanged String?
  oldValue     String?  @db.Text
  newValue     String?  @db.Text
  changedAt    DateTime @default(now())

  @@index([riskId])
  @@index([changedAt])
  @@map("risk_audit_log")
}

// ── Site Settings (branding persistence) ─────────────────────────────────────

model SiteSettings {
  id             String   @id @default("default")
  logoBase64     String?  @db.Text
  logoMarkBase64 String?  @db.Text
  logoX          Int      @default(16)
  logoY          Int      @default(16)
  logoScale      Float    @default(1.0)
  primaryColour  String?
  accentColour   String?
  updatedAt      DateTime @updatedAt
  updatedBy      String?

  @@map("site_settings")
}

// ── Priority Definitions ─────────────────────────────────────────────────────

model PriorityDefinition {
  code        String   @id
  label       String
  description String?  @db.Text
  sortOrder   Int      @default(0)
  updatedAt   DateTime @updatedAt

  @@map("priority_definitions")
}

// ── Controls Testing Module ──────────────────────────────────────────────────

enum ControlFrequency {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  BI_ANNUAL
  ANNUAL
  EVENT_DRIVEN
}

enum TestingFrequency {
  MONTHLY
  QUARTERLY
  BI_ANNUAL
  ANNUAL
}

enum TestResult {
  PASS
  FAIL
  PARTIALLY
  NOT_TESTED
  NOT_DUE
}

enum QuarterlySummaryStatus {
  DRAFT
  SUBMITTED
  APPROVED
}

enum ConsumerDutyOutcomeType {
  PRODUCTS_AND_SERVICES
  CONSUMER_UNDERSTANDING
  CONSUMER_SUPPORT
  GOVERNANCE_CULTURE_OVERSIGHT
}

enum InternalOrThirdParty {
  INTERNAL
  THIRD_PARTY
}

enum ControlType {
  PREVENTATIVE
  DETECTIVE
  CORRECTIVE
  DIRECTIVE
}

model ControlBusinessArea {
  id        String   @id @default(cuid())
  name      String   @unique
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  controls Control[]

  @@map("control_business_areas")
}

model Control {
  id                  String                  @id @default(cuid())
  controlRef          String                  @unique
  controlName         String
  controlDescription  String                  @db.Text
  businessAreaId      String
  businessArea        ControlBusinessArea     @relation(fields: [businessAreaId], references: [id])
  controlOwnerId      String
  controlOwner        User                    @relation("ControlOwner", fields: [controlOwnerId], references: [id])
  consumerDutyOutcome ConsumerDutyOutcomeType
  controlFrequency    ControlFrequency
  internalOrThirdParty InternalOrThirdParty   @default(INTERNAL)
  controlType          ControlType?
  isActive            Boolean                 @default(true)
  standingComments    String?                 @db.Text
  createdAt           DateTime                @default(now())
  createdById         String
  createdBy           User                    @relation("ControlCreatedBy", fields: [createdById], references: [id])
  archivedAt          DateTime?
  updatedAt           DateTime                @updatedAt

  attestations        ControlAttestation[]
  testingSchedule     TestingScheduleEntry?
  changes             ControlChange[]
  actions             Action[]                @relation("ControlActions")
  riskAcceptances     RiskAcceptance[]
  policyLinks         PolicyControlLink[]     @relation("PolicyControlLinks")

  @@index([businessAreaId])
  @@index([controlOwnerId])
  @@index([businessAreaId, isActive])
  @@map("controls_library")
}

model ControlAttestation {
  id               String   @id @default(cuid())
  controlId        String
  control          Control  @relation(fields: [controlId], references: [id], onDelete: Cascade)
  periodYear       Int
  periodMonth      Int
  attested         Boolean
  attestedById     String
  attestedBy       User     @relation("AttestationBy", fields: [attestedById], references: [id])
  attestedAt       DateTime @default(now())
  comments         String?  @db.Text
  issuesFlagged    Boolean  @default(false)
  issueDescription String?  @db.Text

  ccroReviewedById String?
  ccroReviewedBy   User?    @relation("AttestationCCROReviewer", fields: [ccroReviewedById], references: [id])
  ccroReviewedAt   DateTime?
  ccroAgreement    Boolean?
  ccroComments     String?  @db.Text

  @@unique([controlId, periodYear, periodMonth])
  @@index([controlId])
  @@index([attestedById])
  @@map("control_attestations")
}

model TestingScheduleEntry {
  id                String           @id @default(cuid())
  controlId         String           @unique
  control           Control          @relation(fields: [controlId], references: [id], onDelete: Cascade)
  testingFrequency  TestingFrequency
  assignedTesterId  String
  assignedTester    User             @relation("AssignedTester", fields: [assignedTesterId], references: [id])
  summaryOfTest     String           @db.Text
  isActive          Boolean          @default(true)
  standingComments  String?          @db.Text
  addedAt           DateTime         @default(now())
  addedById         String
  addedBy           User             @relation("ScheduleAddedBy", fields: [addedById], references: [id])
  removedAt         DateTime?
  removedReason     String?

  testResults       ControlTestResult[]
  quarterlySummaries QuarterlySummary[]

  @@index([assignedTesterId])
  @@map("testing_schedule")
}

model ControlTestResult {
  id               String               @id @default(cuid())
  scheduleEntryId  String
  scheduleEntry    TestingScheduleEntry @relation(fields: [scheduleEntryId], references: [id], onDelete: Cascade)
  periodYear       Int
  periodMonth      Int
  result           TestResult
  testedById       String
  testedBy         User                 @relation("TestResultBy", fields: [testedById], references: [id])
  testedDate       DateTime             @default(now())
  effectiveDate    DateTime?            @db.Date
  notes            String?              @db.Text
  evidenceLinks    String[]
  isBackdated      Boolean              @default(false)
  updatedAt        DateTime             @updatedAt
  updatedById      String?
  updatedBy        User?                @relation("TestResultUpdatedBy", fields: [updatedById], references: [id])

  @@unique([scheduleEntryId, periodYear, periodMonth])
  @@index([scheduleEntryId])
  @@index([testedById])
  @@map("control_test_results")
}

model QuarterlySummary {
  id               String                @id @default(cuid())
  scheduleEntryId  String
  scheduleEntry    TestingScheduleEntry  @relation(fields: [scheduleEntryId], references: [id], onDelete: Cascade)
  quarter          String                // e.g. "Q1 2026"
  narrative        String                @db.Text
  authorId         String
  author           User                  @relation("SummaryAuthor", fields: [authorId], references: [id])
  status           QuarterlySummaryStatus @default(DRAFT)
  approvedById     String?
  approvedBy       User?                 @relation("SummaryApprover", fields: [approvedById], references: [id])
  approvedAt       DateTime?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  @@unique([scheduleEntryId, quarter])
  @@index([scheduleEntryId])
  @@map("quarterly_summaries")
}

model ExcoViewConfig {
  id                       String   @id @default(cuid())
  periodYear               Int
  periodMonth              Int
  showDashboardSummary     Boolean  @default(true)
  showPassRateByArea       Boolean  @default(true)
  showPassRateByCDOutcome  Boolean  @default(true)
  showAttestationOverview  Boolean  @default(true)
  showAttentionRequired    Boolean  @default(true)
  showTrendAnalysis        Boolean  @default(true)
  showQuarterlySummaries   Boolean  @default(true)
  controlVisibility        Json     @default("{}") // Record<controlId, "SHOW" | "SUMMARY_ONLY" | "HIDE">
  configuredById           String
  configuredBy             User     @relation("ExcoConfiguredBy", fields: [configuredById], references: [id])
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  @@unique([periodYear, periodMonth])
  @@map("exco_view_configs")
}

// ── Policy Review Module ──────────────────────────────────────────────────

enum PolicyStatus {
  CURRENT
  OVERDUE
  UNDER_REVIEW
  ARCHIVED
}

enum RegulationType {
  HANDBOOK_RULE
  PRINCIPLE
  LEGISLATION
  STATUTORY_INSTRUMENT
  GUIDANCE
  INDUSTRY_CODE
}

model Policy {
  id                  String       @id @default(cuid())
  reference           String       @unique
  name                String
  description         String       @db.Text
  status              PolicyStatus @default(CURRENT)
  version             String       @default("1.0")
  ownerId             String
  owner               User         @relation("OwnedPolicies", fields: [ownerId], references: [id])
  approvedBy          String?
  classification      String       @default("Internal Only")
  reviewFrequencyDays Int          @default(365)
  lastReviewedDate    DateTime?
  nextReviewDate      DateTime?
  effectiveDate       DateTime?
  scope               String?      @db.Text
  applicability       String?      @db.Text
  exceptions          String?      @db.Text
  relatedPolicies     String[]
  storageUrl          String?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  regulatoryLinks PolicyRegulatoryLink[]
  controlLinks    PolicyControlLink[]
  obligations     PolicyObligation[]
  auditTrail      PolicyAuditLog[]

  @@index([ownerId])
  @@index([status])
  @@map("policies")
}

model Regulation {
  id          String         @id @default(cuid())
  reference   String         @unique
  name        String
  shortName   String?
  body        String
  type        RegulationType
  provisions  String?        @db.Text
  url         String?
  description String?        @db.Text
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  policyLinks PolicyRegulatoryLink[]

  @@map("regulations")
}

model PolicyRegulatoryLink {
  id             String     @id @default(cuid())
  policyId       String
  policy         Policy     @relation(fields: [policyId], references: [id], onDelete: Cascade)
  regulationId   String
  regulation     Regulation @relation(fields: [regulationId], references: [id])
  policySections String?
  notes          String?
  linkedAt       DateTime   @default(now())
  linkedBy       String

  @@unique([policyId, regulationId])
  @@map("policy_regulatory_links")
}

model PolicyControlLink {
  id        String   @id @default(cuid())
  policyId  String
  policy    Policy   @relation(fields: [policyId], references: [id], onDelete: Cascade)
  controlId String
  control   Control  @relation("PolicyControlLinks", fields: [controlId], references: [id])
  notes     String?
  linkedAt  DateTime @default(now())
  linkedBy  String

  @@unique([policyId, controlId])
  @@map("policy_control_links")
}

model PolicyObligation {
  id             String   @id @default(cuid())
  policyId       String
  policy         Policy   @relation(fields: [policyId], references: [id], onDelete: Cascade)
  reference      String   @unique
  category       String
  description    String   @db.Text
  regulationRefs String[]
  controlRefs    String[]
  notes          String?  @db.Text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([policyId])
  @@map("policy_obligations")
}

model PolicyAuditLog {
  id           String   @id @default(cuid())
  policyId     String
  policy       Policy   @relation(fields: [policyId], references: [id], onDelete: Cascade)
  userId       String
  action       String
  fieldChanged String?
  oldValue     String?  @db.Text
  newValue     String?  @db.Text
  details      String?  @db.Text
  changedAt    DateTime @default(now())

  @@index([policyId])
  @@index([changedAt])
  @@map("policy_audit_log")
}

// ── Risk Acceptance Module ──────────────────────────────────────────────────

enum RiskAcceptanceStatus {
  PROPOSED
  CCRO_REVIEW
  AWAITING_APPROVAL
  APPROVED
  REJECTED
  RETURNED
  EXPIRED
}

enum RiskAcceptanceSource {
  RISK_REGISTER
  CONTROL_TESTING
  INCIDENT
  AD_HOC
}

model RiskAcceptance {
  id                    String                @id @default(cuid())
  reference             String                @unique
  title                 String
  description           String                @db.Text
  source                RiskAcceptanceSource
  status                RiskAcceptanceStatus  @default(PROPOSED)
  riskId                String?
  risk                  Risk?                 @relation(fields: [riskId], references: [id], onDelete: SetNull)
  proposerId            String
  proposer              User                  @relation("AcceptanceProposer", fields: [proposerId], references: [id])
  approverId            String?
  approver              User?                 @relation("AcceptanceApprover", fields: [approverId], references: [id])
  proposedRationale     String                @db.Text
  proposedConditions    String?               @db.Text
  approverRationale     String?               @db.Text
  ccroNote              String?               @db.Text
  reviewDate            DateTime?
  approvedAt            DateTime?
  rejectedAt            DateTime?
  expiredAt             DateTime?
  consumerDutyOutcomeId String?
  consumerDutyOutcome   ConsumerDutyOutcome?  @relation(fields: [consumerDutyOutcomeId], references: [id], onDelete: SetNull)
  linkedControlId       String?
  linkedControl         Control?              @relation(fields: [linkedControlId], references: [id], onDelete: SetNull)
  linkedActionIds       String[]
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  comments RiskAcceptanceComment[]
  history  RiskAcceptanceHistory[]

  @@index([status])
  @@index([proposerId])
  @@index([approverId])
  @@index([riskId])
  @@map("risk_acceptances")
}

model RiskAcceptanceComment {
  id           String         @id @default(cuid())
  acceptanceId String
  acceptance   RiskAcceptance @relation(fields: [acceptanceId], references: [id], onDelete: Cascade)
  userId       String
  user         User           @relation(fields: [userId], references: [id])
  content      String         @db.Text
  createdAt    DateTime       @default(now())

  @@index([acceptanceId])
  @@map("risk_acceptance_comments")
}

model RiskAcceptanceHistory {
  id           String         @id @default(cuid())
  acceptanceId String
  acceptance   RiskAcceptance @relation(fields: [acceptanceId], references: [id], onDelete: Cascade)
  userId       String?
  user         User?          @relation(fields: [userId], references: [id])
  action       String
  fromStatus   String?
  toStatus     String?
  details      String         @db.Text
  metadata     Json?
  createdAt    DateTime       @default(now())

  @@index([acceptanceId])
  @@map("risk_acceptance_history")
}

model RiskChange {
  id           String       @id @default(cuid())
  riskId       String
  risk         Risk         @relation(fields: [riskId], references: [id], onDelete: Cascade)
  fieldChanged String
  oldValue     String?      @db.Text
  newValue     String?      @db.Text
  status       ChangeStatus @default(PENDING)
  proposedBy   String
  proposer     User         @relation("RiskProposedChanges", fields: [proposedBy], references: [id])
  proposedAt   DateTime     @default(now())
  reviewedBy   String?
  reviewer     User?        @relation("RiskReviewedChanges", fields: [reviewedBy], references: [id])
  reviewNote   String?      @db.Text

  @@index([riskId])
  @@index([status])
  @@map("risk_changes")
}

model DashboardNotification {
  id          String    @id @default(cuid())
  message     String    @db.Text
  type        String    @default("info") // "info" | "warning" | "urgent"
  active      Boolean   @default(true)
  targetRoles String[]  // empty = all roles
  createdBy   String
  creator     User      @relation("NotificationCreator", fields: [createdBy], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  expiresAt   DateTime?

  @@map("dashboard_notifications")
}
