generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  CCRO_TEAM
  OWNER
  VIEWER
}

enum ReportStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum RAGStatus {
  GOOD
  WARNING
  HARM
}

enum SectionType {
  TEXT_BLOCK
  DATA_TABLE
  CONSUMER_DUTY_DASHBOARD
  CHART
  CARD_GRID
  IMPORTED_COMPONENT
  TEMPLATE_INSTANCE
  ACCORDION
  IMAGE_BLOCK
}

enum ActionStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  OVERDUE
  PROPOSED_CLOSED
}

enum ActionPriority {
  P1
  P2
  P3
}

enum ChangeStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ControlEffectiveness {
  EFFECTIVE
  PARTIALLY_EFFECTIVE
  INEFFECTIVE
}

enum RiskAppetite {
  VERY_LOW
  LOW
  LOW_TO_MODERATE
  MODERATE
}

enum DirectionOfTravel {
  IMPROVING
  STABLE
  DETERIORATING
}

enum MitigationStatus {
  OPEN
  IN_PROGRESS
  COMPLETE
}

model User {
  id                  String    @id @default(cuid())
  email               String    @unique
  name                String
  role                Role      @default(VIEWER)
  assignedMeasures    String[]
  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  lastLoginAt         DateTime?
  updatedAt           DateTime  @updatedAt

  reports         Report[]        @relation("CreatedReports")
  versions        ReportVersion[] @relation("PublishedVersions")
  templates       Template[]
  components      Component[]
  auditLogs       AuditLog[]
  assignedActions Action[]        @relation("AssignedActions")
  createdActions  Action[]        @relation("CreatedActions")
  proposedChanges ActionChange[]  @relation("ProposedChanges")
  reviewedChanges ActionChange[]  @relation("ReviewedChanges")
  createdRisks    Risk[]          @relation("CreatedRisks")
  updatedRisks    Risk[]          @relation("UpdatedRisks")
  ownedRisks      Risk[]          @relation("OwnedRisks")

  @@map("users")
}

model Report {
  id        String       @id @default(cuid())
  title     String
  period    String
  status    ReportStatus @default(DRAFT)
  createdBy String
  creator   User         @relation("CreatedReports", fields: [createdBy], references: [id])
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  sections  Section[]
  versions  ReportVersion[]
  outcomes  ConsumerDutyOutcome[]
  auditLogs AuditLog[]
  actions   Action[]

  @@map("reports")
}

model Section {
  id           String      @id @default(cuid())
  reportId     String
  report       Report      @relation(fields: [reportId], references: [id], onDelete: Cascade)
  type         SectionType
  position     Int
  title        String?
  content      Json        @default("{}")
  layoutConfig Json        @default("{}")
  styleConfig  Json        @default("{}")
  templateId   String?
  componentId  String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@map("sections")
}

model ConsumerDutyOutcome {
  id                   String    @id @default(cuid())
  reportId             String?
  report               Report?   @relation(fields: [reportId], references: [id], onDelete: Cascade)
  outcomeId            String
  name                 String
  shortDesc            String
  detailedDescription  String?   @db.Text
  riskOwner            String?
  previousRAG          RAGStatus?
  mitigatingActions    String?   @db.Text
  monthlySummary       String?   @db.Text
  icon                 String?
  ragStatus            RAGStatus @default(GOOD)
  position             Int       @default(0)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  measures ConsumerDutyMeasure[]

  @@unique([reportId, outcomeId])
  @@map("consumer_duty_outcomes")
}

model ConsumerDutyMeasure {
  id            String    @id @default(cuid())
  outcomeId     String
  outcome       ConsumerDutyOutcome @relation(fields: [outcomeId], references: [id], onDelete: Cascade)
  measureId     String
  name          String
  owner         String?
  summary       String    @default("")
  ragStatus     RAGStatus @default(GOOD)
  position      Int       @default(0)
  lastUpdatedAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  metrics ConsumerDutyMI[]

  @@map("consumer_duty_measures")
}

model ConsumerDutyMI {
  id               String    @id @default(cuid())
  measureId        String
  measure          ConsumerDutyMeasure @relation(fields: [measureId], references: [id], onDelete: Cascade)
  metric           String
  current          String    @default("")
  previous         String    @default("")
  change           String    @default("")
  ragStatus        RAGStatus @default(GOOD)
  appetite         String?
  appetiteOperator String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  snapshots MetricSnapshot[]

  @@map("consumer_duty_mi")
}

model MetricSnapshot {
  id        String    @id @default(cuid())
  miId      String
  mi        ConsumerDutyMI @relation(fields: [miId], references: [id], onDelete: Cascade)
  month     DateTime
  value     String
  ragStatus RAGStatus @default(GOOD)
  createdAt DateTime  @default(now())

  @@unique([miId, month])
  @@index([miId])
  @@map("metric_snapshots")
}

model ReportVersion {
  id           String   @id @default(cuid())
  reportId     String
  report       Report   @relation(fields: [reportId], references: [id], onDelete: Cascade)
  version      Int
  snapshotData Json
  htmlExport   String?  @db.Text
  publishedBy  String
  publisher    User     @relation("PublishedVersions", fields: [publishedBy], references: [id])
  publishedAt  DateTime @default(now())
  publishNote  String?

  @@unique([reportId, version])
  @@map("report_versions")
}

model Template {
  id            String      @id @default(cuid())
  name          String
  description   String      @default("")
  category      String      @default("General")
  thumbnailUrl  String?
  layoutConfig  Json        @default("{}")
  styleConfig   Json        @default("{}")
  contentSchema Json        @default("[]")
  sectionType   SectionType @default(TEXT_BLOCK)
  createdBy     String
  creator       User        @relation(fields: [createdBy], references: [id])
  isGlobal      Boolean     @default(false)
  version       Int         @default(1)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@map("templates")
}

model Component {
  id          String   @id @default(cuid())
  name        String
  description String   @default("")
  category    String   @default("General")
  htmlContent String   @db.Text
  cssContent  String?  @db.Text
  jsContent   String?  @db.Text
  version     String   @default("1.0")
  sanitized   Boolean  @default(false)
  createdBy   String
  creator     User     @relation(fields: [createdBy], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("components")
}

model AuditLog {
  id         String   @id @default(cuid())
  timestamp  DateTime @default(now())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  userRole   Role
  action     String
  entityType String
  entityId   String?
  changes    Json?
  reportId   String?
  report     Report?  @relation(fields: [reportId], references: [id], onDelete: SetNull)
  ipAddress  String?
  userAgent  String?

  @@index([userId])
  @@index([reportId])
  @@index([timestamp])
  @@index([action])
  @@map("audit_logs")
}

model Action {
  id            String       @id @default(cuid())
  reference     String       @unique
  reportId      String?
  report        Report?      @relation(fields: [reportId], references: [id], onDelete: Cascade)
  reportPeriod  String?
  source        String?      @db.Text
  sectionId     String?
  sectionTitle  String?
  title         String
  description   String       @default("") @db.Text
  status        ActionStatus @default(OPEN)
  priority      ActionPriority?
  assignedTo    String
  assignee      User         @relation("AssignedActions", fields: [assignedTo], references: [id])
  createdBy     String
  creator       User         @relation("CreatedActions", fields: [createdBy], references: [id])
  dueDate       DateTime?
  completedAt   DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  changes          ActionChange[]
  linkedMitigation RiskMitigation? @relation("MitigationAction")

  @@index([reportId])
  @@index([assignedTo])
  @@index([status])
  @@index([dueDate])
  @@index([source])
  @@map("actions")
}

model ActionChange {
  id           String       @id @default(cuid())
  actionId     String
  action       Action       @relation(fields: [actionId], references: [id], onDelete: Cascade)
  proposedBy   String
  proposer     User         @relation("ProposedChanges", fields: [proposedBy], references: [id])
  fieldChanged String
  oldValue     String?      @db.Text
  newValue     String?      @db.Text
  proposedAt   DateTime     @default(now())
  status       ChangeStatus @default(PENDING)
  reviewedBy   String?
  reviewer     User?        @relation("ReviewedChanges", fields: [reviewedBy], references: [id])
  reviewedAt   DateTime?
  reviewNote   String?
  evidenceUrl  String?      @db.Text
  evidenceName String?
  isUpdate     Boolean      @default(false)

  @@index([actionId])
  @@index([status])
  @@map("action_changes")
}

// ── Risk Register ──────────────────────────────────────────────────────────────

model RiskCategory {
  id         String  @id @default(cuid())
  level      Int
  parentId   String?
  parent     RiskCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children   RiskCategory[] @relation("CategoryHierarchy")
  name       String
  definition String  @db.Text

  @@map("risk_categories")
}

model Risk {
  id                   String               @id @default(cuid())
  reference            String               @unique
  name                 String
  description          String               @db.Text
  categoryL1           String
  categoryL2           String
  ownerId              String
  riskOwner            User                 @relation("OwnedRisks", fields: [ownerId], references: [id])
  inherentLikelihood   Int
  inherentImpact       Int
  residualLikelihood   Int
  residualImpact       Int
  controlEffectiveness ControlEffectiveness?
  riskAppetite         RiskAppetite?
  directionOfTravel    DirectionOfTravel    @default(STABLE)
  reviewFrequencyDays  Int                  @default(90)
  reviewRequested      Boolean              @default(false)
  lastReviewed         DateTime             @default(now()) @db.Date
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  createdBy            String
  creator              User                 @relation("CreatedRisks", fields: [createdBy], references: [id])
  updatedBy            String
  updater              User                 @relation("UpdatedRisks", fields: [updatedBy], references: [id])

  controls    RiskControl[]
  mitigations RiskMitigation[]
  auditTrail  RiskAuditLog[]
  snapshots   RiskSnapshot[]

  @@index([categoryL1])
  @@index([ownerId])
  @@map("risks")
}

model RiskControl {
  id          String   @id @default(cuid())
  riskId      String
  risk        Risk     @relation(fields: [riskId], references: [id], onDelete: Cascade)
  description String   @db.Text
  controlOwner String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([riskId])
  @@map("risk_controls")
}

model RiskMitigation {
  id           String           @id @default(cuid())
  riskId       String
  risk         Risk             @relation(fields: [riskId], references: [id], onDelete: Cascade)
  action       String           @db.Text
  owner        String?
  deadline     DateTime?        @db.Date
  status       MitigationStatus @default(OPEN)
  actionId     String?          @unique
  linkedAction Action?          @relation("MitigationAction", fields: [actionId], references: [id], onDelete: Cascade)
  createdAt    DateTime         @default(now())

  @@index([riskId])
  @@index([actionId])
  @@map("risk_mitigations")
}

model RiskSnapshot {
  id                  String            @id @default(cuid())
  riskId              String
  risk                Risk              @relation(fields: [riskId], references: [id], onDelete: Cascade)
  month               DateTime
  residualLikelihood  Int
  residualImpact      Int
  inherentLikelihood  Int
  inherentImpact      Int
  directionOfTravel   DirectionOfTravel @default(STABLE)

  @@unique([riskId, month])
  @@index([riskId])
  @@map("risk_snapshots")
}

model RiskAuditLog {
  id           String   @id @default(cuid())
  riskId       String
  risk         Risk     @relation(fields: [riskId], references: [id], onDelete: Cascade)
  userId       String
  action       String
  fieldChanged String?
  oldValue     String?  @db.Text
  newValue     String?  @db.Text
  changedAt    DateTime @default(now())

  @@index([riskId])
  @@index([changedAt])
  @@map("risk_audit_log")
}

// ── Site Settings (branding persistence) ─────────────────────────────────────

model SiteSettings {
  id             String   @id @default("default")
  logoBase64     String?  @db.Text
  logoMarkBase64 String?  @db.Text
  logoX          Int      @default(16)
  logoY          Int      @default(16)
  logoScale      Float    @default(1.0)
  primaryColour  String?
  accentColour   String?
  updatedAt      DateTime @updatedAt
  updatedBy      String?

  @@map("site_settings")
}

// ── Priority Definitions ─────────────────────────────────────────────────────

model PriorityDefinition {
  code        String   @id
  label       String
  description String?  @db.Text
  sortOrder   Int      @default(0)
  updatedAt   DateTime @updatedAt

  @@map("priority_definitions")
}
